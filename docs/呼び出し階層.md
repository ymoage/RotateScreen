# RotateScreen 関数呼び出し階層

| 項目 | 値 |
|------|-----|
| バージョン | v1.3.3 |
| 更新日 | 2025-12-28 |

各コンポーネントの関数呼び出し階層を図示します。

---

## 目次

1. [Content Script (content/index.js)](#content-script)
2. [AI Detector (content/ai-detector.js)](#ai-detector)
3. [Face Detector (content/face-detector.js)](#face-detector)
4. [コンポーネント間通信](#コンポーネント間通信)

---

## Content Script

### エントリーポイント

```
initialize()                          ← ページ読み込み時に自動実行
├── isYouTube()                       # YouTubeページか判定
├── loadSettings()                    # 設定を読み込み
│   └── chrome.storage.local.get()
├── waitForPlayer()                   # プレイヤー準備待機
│   └── isPlayerReady()
│       ├── detectPlayer()
│       └── detectVideo()
├── setupRotation()                   # 回転機能セットアップ
│   ├── injectUI()                    # UIを注入
│   │   ├── injectControlbarUI()      # コントロールバーに配置
│   │   │   ├── removeExistingButton()
│   │   │   ├── createRotateButton()
│   │   │   └── updateButtonState()
│   │   └── injectOverlayUI()         # オーバーレイに配置
│   │       ├── removeExistingButton()
│   │       ├── detectVideoContainer()
│   │       ├── detectPlayer()
│   │       ├── createRotateButton()
│   │       └── updateButtonState()
│   ├── loadVideoRotation()           # 保存済み回転を読み込み
│   │   └── chrome.storage.local.get()
│   ├── setRotation()                 # 通常回転を適用
│   │   └── updateButtonState()
│   └── setFreeRotation()             # フリー回転を適用
│       └── updateButtonState()
├── handleKeyDown()                   # キーボードイベント登録
│   ├── handleRotate()                # Rキー: 回転
│   └── toggleMirror()                # Hキー: 左右反転
├── handleFullscreenChange()          # フルスクリーン監視
│   ├── setRotation()
│   ├── setFreeRotation()
│   └── setMirror()                   # ミラー状態を復元
└── observeVideoChange()              # 動画切り替え監視
    └── setupRotation()
```

### ボタン操作

```
createRotateButton()
├── click イベント
│   ├── clearFreeRotation()           # フリー回転をクリア
│   └── handleRotate()
│       ├── rotateNext()
│       │   └── setRotation()
│       └── saveVideoRotation()
│
├── mousedown イベント（長押し）
│   └── startFreeRotation()
│       ├── showFreeRotationIndicator()
│       └── setInterval()
│           ├── setFreeRotation()
│           └── updateFreeRotationIndicator()
│
├── mouseup イベント
│   └── stopFreeRotation()
│       ├── hideFreeRotationIndicator()
│       └── saveFreeVideoRotation()
│
├── contextmenu イベント（右クリック）
│   └── handleManualAIDetection()
│       ├── showNotification()
│       ├── RotateScreenAIDetector.detectVideoOrientation()
│       ├── setRotation()
│       └── saveVideoRotation()
│
└── dblclick イベント
    └── resetRotation()
        ├── setRotation(0)
        ├── clearFreeRotation()
        └── updateButtonState()
```

### 回転制御

```
setRotation(rotation)
├── isValidRotation()                 # 角度チェック
├── detectVideo()                     # 動画要素取得
├── removeRotationClasses()           # 既存クラス削除
├── video.classList.add()             # 回転クラス適用
└── updateButtonState()               # ボタン状態更新

setFreeRotation(angle)
├── detectVideo()                     # 動画要素取得
├── removeRotationClasses()           # 既存クラス削除
├── スケール計算                       # 角度に応じたスケール
├── video.style.setProperty()         # CSS変数設定
├── video.classList.add()             # フリー回転クラス適用
└── updateButtonState()               # ボタン状態更新

resetRotation()
├── setRotation(DEFAULT_ROTATION)
├── currentFreeRotation = 0
├── isFreeRotationMode = false
└── setMirror(false)                  # ミラーもリセット

setMirror(mirrored)
├── detectVideo()                     # 動画要素取得
├── video.classList.add/remove()      # ミラークラスの追加/削除
└── updateButtonState()               # ボタン状態更新

toggleMirror()
├── setMirror(!isMirrored)
└── showNotification()                # 通知を表示
```

---

## AI Detector

### 向き検出フロー

```
detectVideoOrientation(video, options)
├── captureFrameRaw()                 # 動画フレームをキャプチャ
│   ├── canvas.drawImage()
│   └── canvas.toDataURL()
└── detectOrientationByAI()           # AI判定実行
    ├── [aiMode === 'direct']
    │   └── detectOrientationDirect()
    │       ├── fetchWithTimeout()
    │       │   └── fetch() → Gemini API
    │       └── レスポンス解析
    │
    └── [aiMode === 'worker']
        └── detectOrientationByWorker()
            ├── fetchWithTimeout()
            │   └── fetch() → Cloudflare Worker
            └── レスポンス解析
```

### 設定読み込み

```
loadSettings()                        ← 初期化時に自動実行
└── chrome.storage.local.get()

chrome.storage.onChanged              ← 設定変更を監視
└── 設定値を更新
```

---

## Face Detector

### 向き検出フロー

```
detectVideoOrientation(video)
├── captureFrame()                    # 動画フレームをキャプチャ
│   ├── canvas.drawImage()
│   └── canvas.toDataURL()
├── [FaceDetector API available]
│   └── detectWithFaceDetector()
│       ├── new FaceDetector()
│       └── detector.detect()
└── [fallback]
    └── detectWithSkinColor()
        ├── getImageData()
        └── 肌色領域分析
```

---

## コンポーネント間通信

### メッセージフロー

```
┌─────────────┐      chrome.runtime.sendMessage()      ┌─────────────┐
│   Content   │ ──────────────────────────────────────→ │  Service    │
│   Script    │                                         │  Worker     │
│             │ ←────────────────────────────────────── │             │
└─────────────┘           sendResponse()                └─────────────┘
       │                                                       │
       │                                                       │
       │  chrome.storage.local                                 │
       │         ↓                                             │
       └─────→ ┌───────────────┐ ←─────────────────────────────┘
               │ Chrome Storage │
               └───────────────┘
```

### メッセージタイプ

```
GET_SETTINGS
├── Content Script → Service Worker
└── Service Worker → Storage → sendResponse

UPDATE_SETTINGS
├── Popup/Options → Service Worker
└── Service Worker → Storage → sendResponse

SAVE_ROTATION
├── Content Script → Service Worker
└── Service Worker → Storage

GET_ROTATION
├── Content Script → Service Worker
└── Service Worker → Storage → sendResponse

CLEAR_ALL_ROTATIONS
├── Options → Service Worker
└── Service Worker → Storage → sendResponse
```

---

## イベントフロー図

### 通常回転（クリック）

```
ユーザー
   │
   │ クリック
   ▼
createRotateButton.click
   │
   ├── clearFreeRotation()  [フリー回転中の場合]
   │
   ▼
handleRotate()
   │
   ▼
rotateNext()
   │
   ├── getNextRotation()
   │       │
   │       └── (current + 90) % 360
   │
   └── setRotation()
           │
           ├── removeRotationClasses()
           ├── video.classList.add()
           └── updateButtonState()
```

### フリー回転（長押し）

```
ユーザー
   │
   │ mousedown（長押し開始）
   ▼
startLongPress()
   │
   │ 300ms後
   ▼
startFreeRotation()
   │
   ├── showFreeRotationIndicator()
   │
   └── setInterval (50ms)
           │
           ├── setFreeRotation(angle + 3°)
           │       │
           │       ├── スケール計算
           │       ├── CSS変数設定
           │       └── updateButtonState()
           │
           └── updateFreeRotationIndicator()

ユーザー
   │
   │ mouseup（離す）
   ▼
stopFreeRotation()
   │
   ├── clearInterval()
   ├── hideFreeRotationIndicator()
   └── saveFreeVideoRotation()
```

### AI判定（右クリック）

```
ユーザー
   │
   │ 右クリック
   ▼
contextmenu イベント
   │
   ▼
handleManualAIDetection()
   │
   ├── showNotification('AI判定を実行中...')
   │
   ▼
RotateScreenAIDetector.detectVideoOrientation()
   │
   ├── captureFrameRaw()
   │
   └── detectOrientationByAI()
           │
           └── Gemini API呼び出し
                   │
                   ▼
              判定結果
                   │
   ┌───────────────┴───────────────┐
   │                               │
   ▼                               ▼
成功                              失敗
   │                               │
   ├── setRotation()               └── showNotification('エラー')
   ├── saveVideoRotation()
   └── showNotification('成功')
```
