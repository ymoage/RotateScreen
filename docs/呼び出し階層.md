# RotateScreen 関数呼び出し階層

| 項目 | 値 |
|------|-----|
| バージョン | v1.1.0 |
| リビジョン | e1f75b0 |
| 更新日 | 2025-12-09 |

各コンポーネントの関数呼び出し階層を図示します。

---

## 目次

1. [Content Script (content/index.js)](#content-script)
2. [Background Service Worker (background/service-worker.js)](#background-service-worker)
3. [Popup (popup/popup.js)](#popup)
4. [Options (options/options.js)](#options)
5. [Settings Manager (storage/settings-manager.js)](#settings-manager)
6. [コンポーネント間通信](#コンポーネント間通信)

---

## Content Script

### エントリーポイント

```
initialize()                          ← ページ読み込み時に自動実行
├── isYouTube()                       # YouTubeページか判定
├── loadSettings()                    # 設定を読み込み
│   └── chrome.storage.local.get()
├── waitForPlayer()                   # プレイヤー準備待機
│   └── isPlayerReady()
│       ├── detectPlayer()
│       └── detectVideo()
├── setupRotation()                   # 回転機能セットアップ
│   ├── injectUI()                    # UIを注入
│   │   ├── injectControlbarUI()      # コントロールバーに配置
│   │   │   ├── removeExistingButton()
│   │   │   ├── createRotateButton()
│   │   │   └── updateButtonState()
│   │   └── injectOverlayUI()         # オーバーレイに配置
│   │       ├── removeExistingButton()
│   │       ├── detectVideoContainer()
│   │       ├── detectPlayer()
│   │       ├── createRotateButton()
│   │       └── updateButtonState()
│   ├── getCurrentVideoId()
│   │   └── extractVideoId()
│   ├── loadVideoRotation()           # 保存済み回転を読み込み
│   │   └── chrome.storage.local.get()
│   └── setRotation()                 # 回転を適用
│       ├── isValidRotation()
│       ├── detectVideo()
│       ├── removeRotationClasses()
│       └── updateButtonState()
├── document.addEventListener('keydown', handleKeyDown)
├── document.addEventListener('fullscreenchange', handleFullscreenChange)
└── observeVideoChange()              # 動画切り替え監視開始
```

### キーボードショートカット処理

```
handleKeyDown(event)                  ← keydownイベント
├── isInputFocused()                  # 入力欄フォーカス判定
├── matchesHotkey()                   # ホットキー一致判定
└── handleRotate()                    # 回転実行
    ├── rotateNext()
    │   ├── getNextRotation()
    │   └── setRotation()
    │       ├── isValidRotation()
    │       ├── detectVideo()
    │       ├── removeRotationClasses()
    │       └── updateButtonState()
    ├── getCurrentVideoId()
    │   └── extractVideoId()
    └── saveVideoRotation()           # 回転状態を保存
        └── chrome.storage.local.set()
```

### ボタンクリック処理

```
button.click                          ← ボタンクリックイベント
└── handleRotate()
    ├── rotateNext()
    │   ├── getNextRotation()
    │   └── setRotation()
    ├── getCurrentVideoId()
    └── saveVideoRotation()

button.dblclick                       ← ボタンダブルクリックイベント
└── resetRotation()
    └── setRotation(0)
```

### フルスクリーン変更処理

```
handleFullscreenChange()              ← fullscreenchangeイベント
└── setRotation(currentRotation)      # 100ms遅延後に再適用
    ├── isValidRotation()
    ├── detectVideo()
    ├── removeRotationClasses()
    └── updateButtonState()
```

### 動画切り替え監視

```
observeVideoChange()
└── MutationObserver callback
    ├── getCurrentVideoId()
    │   └── extractVideoId()
    ├── removeRotationClasses()       # リセット時
    ├── waitForPlayer()
    └── setupRotation()               # 新動画用にセットアップ
```

---

## Background Service Worker

### メッセージ処理

```
chrome.runtime.onMessage              ← メッセージ受信
└── handleMessage(message)
    ├── [GET_SETTINGS]
    │   └── handleGetSettings()
    │       └── getSettings()         # settings-manager.js
    │
    ├── [UPDATE_SETTINGS]
    │   └── handleUpdateSettings(payload)
    │       └── updateSettings()      # settings-manager.js
    │           └── getSettings()
    │
    ├── [GET_ROTATION]
    │   └── handleGetRotation(payload)
    │       └── getVideoRotation()    # settings-manager.js
    │
    ├── [SAVE_ROTATION]
    │   └── handleSaveRotation(payload)
    │       └── saveVideoRotation()   # settings-manager.js
    │
    └── [CLEAR_ALL_ROTATIONS]
        └── handleClearAllRotations()
            └── clearAllVideoRotations()  # settings-manager.js
```

### インストールイベント

```
chrome.runtime.onInstalled            ← 拡張機能インストール/更新時
└── (ログ出力のみ)
```

---

## Popup

### エントリーポイント

```
initialize()                          ← popup.html読み込み時に自動実行
├── chrome.tabs.query()               # 現在のタブを取得
├── updateSiteInfo(url)               # サイト情報を表示
│   └── showUnsupportedMessage()      # 未対応サイト時
├── loadSettings()                    # 設定を読み込み
│   ├── chrome.runtime.sendMessage(GET_SETTINGS)
│   │   └── → Background → handleGetSettings()
│   └── updateHotkeyHint()            # ショートカット表示更新
└── setupEventListeners()             # イベント設定
```

### 回転ボタンクリック処理

```
rotationButton.click                  ← 回転ボタンクリック
└── setRotation(rotation)
    ├── chrome.tabs.sendMessage(SET_ROTATION)
    │   └── → Content Script
    └── updateRotationUI()
```

### 設定リンククリック処理

```
openOptionsLink.click                 ← 設定リンククリック
└── chrome.runtime.openOptionsPage()
```

---

## Options

### エントリーポイント

```
initialize()                          ← options.html読み込み時に自動実行
├── loadSettings()                    # 設定を読み込み
│   └── chrome.runtime.sendMessage(GET_SETTINGS)
│       └── → Background → handleGetSettings()
└── setupEventListeners()             # イベント設定
```

### 設定変更処理

```
buttonPositionSelect.change           ← ボタン位置変更
└── saveSettings({ buttonPosition })
    ├── chrome.runtime.sendMessage(UPDATE_SETTINGS)
    │   └── → Background → handleUpdateSettings()
    └── showSaveNotification()

hotkeyPresetSelect.change             ← ホットキー変更
└── saveSettings({ hotkeyPreset })

resetOnVideoChangeCheckbox.change     ← リセット設定変更
└── saveSettings({ resetOnVideoChange })

rememberRotationCheckbox.change       ← 記憶設定変更
└── saveSettings({ rememberRotation })

defaultRotationSelect.change          ← デフォルト回転変更
└── saveSettings({ defaultRotation })
```

### 回転設定クリア処理

```
clearRotationsBtn.click               ← クリアボタンクリック
└── clearAllRotations()
    └── chrome.runtime.sendMessage(CLEAR_ALL_ROTATIONS)
        └── → Background → handleClearAllRotations()
```

---

## Settings Manager

### 関数呼び出し関係

```
getSettings()
└── chrome.storage.local.get()

updateSettings(updates)
├── getSettings()                     # 現在の設定を取得
└── chrome.storage.local.set()

getVideoRotation(videoId)
└── chrome.storage.local.get()

saveVideoRotation(videoId, rotation)
├── isValidRotation()                 # constants.js
├── chrome.storage.local.get()
└── chrome.storage.local.set()

deleteVideoRotation(videoId)
├── chrome.storage.local.get()
└── chrome.storage.local.set()

clearAllVideoRotations()
├── chrome.storage.local.get()
└── chrome.storage.local.set()

getAllStorage()
└── chrome.storage.local.get(null)
```

---

## コンポーネント間通信

### 通信フロー図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              User Actions                                │
└───────────┬─────────────────────┬─────────────────────┬─────────────────┘
            │                     │                     │
            ▼                     ▼                     ▼
┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐
│   Content Script  │  │      Popup        │  │     Options       │
│  (content/index)  │  │  (popup/popup)    │  │ (options/options) │
└─────────┬─────────┘  └─────────┬─────────┘  └─────────┬─────────┘
          │                      │                      │
          │ Direct Storage       │ chrome.runtime      │ chrome.runtime
          │ Access               │ .sendMessage()      │ .sendMessage()
          │                      │                     │
          │                      └──────────┬──────────┘
          │                                 │
          │                                 ▼
          │                      ┌───────────────────┐
          │                      │ Background Worker │
          │                      │ (service-worker)  │
          │                      └─────────┬─────────┘
          │                                │
          │                                │ import
          │                                ▼
          │                      ┌───────────────────┐
          └─────────────────────▶│  Settings Manager │
                                 │ (settings-manager)│
                                 └─────────┬─────────┘
                                           │
                                           ▼
                                 ┌───────────────────┐
                                 │  Chrome Storage   │
                                 │      (local)      │
                                 └───────────────────┘
```

### メッセージタイプ一覧

| メッセージ | 送信元 | 受信先 | 処理内容 |
|-----------|--------|--------|---------|
| `GET_SETTINGS` | Popup, Options | Background | 設定を取得 |
| `UPDATE_SETTINGS` | Options | Background | 設定を更新 |
| `GET_ROTATION` | - | Background | 動画の回転設定を取得 |
| `SAVE_ROTATION` | - | Background | 動画の回転設定を保存 |
| `CLEAR_ALL_ROTATIONS` | Options | Background | すべての回転設定を削除 |
| `SET_ROTATION` | Popup | Content Script | 指定角度に回転 |

---

## 関数依存グラフ（簡略版）

```
                    ┌─────────────────┐
                    │   initialize()  │
                    └────────┬────────┘
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  loadSettings() │ │ waitForPlayer() │ │observeVideo()   │
└────────┬────────┘ └────────┬────────┘ └────────┬────────┘
         │                   │                   │
         │                   ▼                   │
         │          ┌─────────────────┐          │
         │          │ setupRotation() │◀─────────┘
         │          └────────┬────────┘
         │                   │
         │     ┌─────────────┼─────────────┐
         │     │             │             │
         │     ▼             ▼             ▼
         │ ┌─────────┐ ┌───────────┐ ┌─────────────────┐
         │ │injectUI │ │loadVideo  │ │  setRotation()  │
         │ │   ()    │ │Rotation() │ └────────┬────────┘
         │ └────┬────┘ └───────────┘          │
         │      │                             │
         │      ▼                             ▼
         │ ┌──────────────────┐    ┌───────────────────┐
         │ │createRotateButton│    │updateButtonState()│
         │ └──────────────────┘    └───────────────────┘
         │
         ▼
┌─────────────────┐       ┌─────────────────┐
│ handleKeyDown() │──────▶│  handleRotate() │
└─────────────────┘       └────────┬────────┘
                                   │
                    ┌──────────────┼──────────────┐
                    │              │              │
                    ▼              ▼              ▼
           ┌────────────┐ ┌─────────────┐ ┌──────────────┐
           │rotateNext()│ │getCurrent   │ │saveVideo     │
           └─────┬──────┘ │VideoId()    │ │Rotation()    │
                 │        └─────────────┘ └──────────────┘
                 ▼
         ┌─────────────┐
         │setRotation()│
         └─────────────┘
```
