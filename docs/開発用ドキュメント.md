# RotateScreen 設計ドキュメント

| 項目 | 値 |
|------|-----|
| バージョン | v1.1.0 |
| リビジョン | e1f75b0 |
| 更新日 | 2025-12-09 |

## 概要

RotateScreenは、YouTube動画を90度単位で回転表示するChrome拡張機能です。横向きで撮影された動画を正しい向きで視聴するために開発されました。

## アーキテクチャ

### 全体構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                        Chrome Browser                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐      │
│  │    Popup     │    │   Options    │    │   Content    │      │
│  │  (popup/*)   │    │ (options/*)  │    │  Scripts     │      │
│  └──────┬───────┘    └──────┬───────┘    │ (content/*)  │      │
│         │                   │            └──────┬───────┘      │
│         │                   │                   │               │
│         └───────────┬───────┴───────────────────┘               │
│                     │ Chrome Messages                           │
│                     ▼                                           │
│         ┌───────────────────────┐                               │
│         │   Service Worker      │                               │
│         │ (background/service-  │                               │
│         │    worker.js)         │                               │
│         └───────────┬───────────┘                               │
│                     │                                           │
│                     ▼                                           │
│         ┌───────────────────────┐                               │
│         │   Chrome Storage      │                               │
│         │   (storage/settings-  │                               │
│         │    manager.js)        │                               │
│         └───────────────────────┘                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### コンポーネント詳細

#### 1. Content Scripts（コンテンツスクリプト）

YouTube上で実行され、動画の回転処理を担当します。

| ファイル | 責務 |
|---------|------|
| `index.js` | メインエントリーポイント。初期化とキーボードイベント処理 |
| `player-detector.js` | YouTubeプレイヤー要素の検出と動画ID抽出 |
| `rotation-control.js` | 回転ロジックの実装。CSS transformの適用 |
| `overlay-ui.js` | 回転ボタンUIの生成と挿入 |

**処理フロー:**
```
ページ読み込み
    │
    ▼
PlayerDetector.init()
    │ プレイヤー要素を検出
    ▼
RotationControl.init()
    │ 回転制御を初期化
    ▼
OverlayUI.init()
    │ ボタンを挿入
    ▼
イベントリスナー登録
    │ キーボード・クリック
    ▼
動画切り替え監視開始
```

#### 2. Background Service Worker

メッセージルーティングとストレージ操作を担当します。

**メッセージタイプ:**

| メッセージ | 方向 | 説明 |
|-----------|------|------|
| `GET_SETTINGS` | Content → BG | 設定を取得 |
| `UPDATE_SETTINGS` | Popup/Options → BG | 設定を更新 |
| `SAVE_ROTATION` | Content → BG | 動画の回転状態を保存 |
| `GET_ROTATION` | Content → BG | 動画の回転状態を取得 |
| `CLEAR_ALL_ROTATIONS` | Options → BG | 保存済み回転をクリア |

#### 3. Popup

拡張機能アイコンクリック時に表示されるクイック操作UI。

**機能:**
- 現在の回転角度表示
- ワンクリック回転ボタン（0°/90°/180°/270°）
- 現在のショートカットキー表示
- 設定ページへのリンク

#### 4. Options

設定画面。ユーザーが動作をカスタマイズできます。

**設定項目:**
- ボタン表示位置
- キーボードショートカット
- 動画切り替え時の動作
- 回転記憶の有無
- デフォルト回転角度

---

## データ構造

### 設定（Settings）

```javascript
{
  hotkeyPreset: 'default' | 'alt' | 'ctrl',
  rememberRotation: boolean,
  resetOnVideoChange: boolean,
  buttonPosition: 'overlay' | 'controlbar',
  defaultRotation: 0 | 90 | 180 | 270
}
```

### 動画回転状態（VideoRotations）

```javascript
{
  [videoId: string]: {
    rotation: 0 | 90 | 180 | 270,
    savedAt: number  // Unix timestamp
  }
}
```

---

## 回転実装の詳細

### CSS Transform アプローチ

動画要素に直接CSSクラスを適用して回転を実現します。

```css
/* 90度回転 */
.rotate-screen-90 {
  transform: rotate(90deg) scale(var(--rotate-screen-scale)) !important;
}

/* 180度回転 */
.rotate-screen-180 {
  transform: rotate(180deg) !important;
}

/* 270度回転 */
.rotate-screen-270 {
  transform: rotate(270deg) scale(var(--rotate-screen-scale)) !important;
}
```

### スケール計算

90度/270度回転時、動画のアスペクト比が変わるため、コンテナに収まるようスケールを調整します。

```javascript
// スケール計算ロジック
function calculateScale(containerWidth, containerHeight) {
  const aspectRatio = containerWidth / containerHeight;
  // 90度/270度回転時は幅と高さが入れ替わる
  return Math.min(1, 1 / aspectRatio);
}
```

### YouTubeスタイル上書き対策

YouTubeはプレイヤー更新時にインラインスタイルを上書きするため、以下の対策を実施:

1. **CSSクラス + !important**: インラインスタイルより優先度を高くする
2. **MutationObserver**: スタイル変更を検知して再適用
3. **フルスクリーン対応**: フルスクリーン切り替え時に回転を再適用

---

## YouTube プレイヤー検出

### 対象セレクター

```javascript
const SELECTORS = {
  player: '#movie_player',
  video: 'video.html5-main-video',
  controlBar: '.ytp-chrome-bottom',
  rightControls: '.ytp-right-controls'
};
```

### 動画ID抽出

複数のURL形式に対応:

| 形式 | パターン | 例 |
|-----|---------|-----|
| 標準 | `/watch?v=` | `youtube.com/watch?v=dQw4w9WgXcQ` |
| ショート | `youtu.be/` | `youtu.be/dQw4w9WgXcQ` |
| 埋め込み | `/embed/` | `youtube.com/embed/dQw4w9WgXcQ` |

```javascript
function extractVideoId(url) {
  const patterns = [
    /[?&]v=([^&]+)/,           // 標準形式
    /youtu\.be\/([^?&]+)/,     // ショート形式
    /\/embed\/([^?&]+)/        // 埋め込み形式
  ];
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match) return match[1];
  }
  return null;
}
```

---

## イベント処理

### キーボードショートカット

```javascript
const HOTKEY_PRESETS = {
  default: { key: 'r', altKey: false, ctrlKey: false, shiftKey: false },
  alt:     { key: 'r', altKey: true,  ctrlKey: false, shiftKey: false },
  ctrl:    { key: 'r', altKey: false, ctrlKey: true,  shiftKey: true }
};
```

**除外条件:**
- 入力欄（input, textarea）にフォーカス中
- contentEditable要素にフォーカス中

### 動画切り替え検出

YouTubeはSPA（Single Page Application）のため、ページ遷移なしで動画が切り替わります。

検出方法:
1. `yt-navigate-finish` イベント
2. URL変更監視（`popstate`イベント）
3. MutationObserverによるプレイヤー更新検知

---

## ストレージ設計

### Chrome Storage API

`chrome.storage.local`を使用（同期不要のため）。

```javascript
// 設定の保存
await chrome.storage.local.set({
  settings: { ...newSettings }
});

// 動画回転の保存
await chrome.storage.local.set({
  videoRotations: {
    ...existing,
    [videoId]: { rotation, savedAt: Date.now() }
  }
});
```

### 容量制限

- `chrome.storage.local`: 最大5MB
- 動画ごとに約100バイト → 約50,000動画分保存可能

---

## ビルドプロセス

### ファイル構成

```
src/           → 開発用ソース（直接読み込み可能）
dist/          → ビルド出力（本番用）
*.zip          → 配布用アーカイブ
```

### ビルドコマンド

```bash
# Node.js
npm run build      # dist/ に出力
npm run package    # ZIP も作成

# PowerShell
.\scripts\build.ps1       # dist/ に出力
.\scripts\build.ps1 -Zip  # ZIP も作成
```

### ビルド処理内容

1. `dist/`フォルダをクリーン
2. 以下をコピー:
   - `manifest.json`
   - `assets/`
   - `background/`
   - `content/`
   - `popup/`
   - `options/`
   - `storage/`
   - `styles/`
   - `utils/`
3. （オプション）ZIPアーカイブ作成

---

## 拡張ポイント

### 新しい回転角度の追加

1. `constants.js`の`ROTATION_ANGLES`配列に角度を追加
2. `overlay.css`に対応するCSSクラスを追加
3. `rotation-control.js`のロジックを更新

### 新しいショートカットプリセット

1. `constants.js`の`HOTKEY_PRESETS`にプリセットを追加
2. `options.html`に選択肢を追加

### 他の動画サイト対応

1. `manifest.json`の`host_permissions`にドメインを追加
2. `youtube-selectors.js`を汎用化または新規セレクターファイル作成
3. `player-detector.js`を拡張

---

## 既知の制限事項

1. **YouTube限定**: 現在はYouTubeのみ対応
2. **Manifest V3**: Chrome専用（Firefox等は未対応）
3. **ライブ配信**: 一部のライブ配信で動作が不安定な場合あり
4. **埋め込みプレイヤー**: 外部サイトの埋め込みは未対応

---

## セキュリティ考慮事項

- **最小権限**: 必要なパーミッションのみ要求
- **XSS対策**: DOM操作時にサニタイズ
- **CSP対応**: インラインスクリプト不使用
- **データ検証**: Storage読み書き時に型チェック
