# RotateScreen 設計ドキュメンチE

| 頁E | 値 |
|------|-----|
| バEジョン | v1.3.1 |
| リビジョン | bff54a9 |
| 更新日 | 2025-12-10 |

## 概要E

RotateScreenは、YouTube動画めE0度単位で回転表示するChrome拡張機Eです。横向きで撮影された動画を正しい向きで視Eするために開発されました、E

### 主要機E

- **手動回転**: RキーまたEボタンで動画めE0度ずつ回転
- **自動回転検EE実験機EEE*: 顔検EまたEAI判定による動画の向き自動判宁E
- **回転記E**: 動画ごとの回転設定を保孁E
- **ライブE信対忁E*: ライブE信では自動回転を無効匁E

## アーキチEチャ

### 全体構E図

```
┌─────────────────────────────────────────────────────────────────━E
━E                       Chrome Browser                            ━E
├─────────────────────────────────────────────────────────────────┤
━E                                                                 ━E
━E ┌──────────────━E   ┌──────────────━E   ┌──────────────━E     ━E
━E ━E   Popup     ━E   ━E  Options    ━E   ━E  Content    ━E     ━E
━E ━E (popup/*)   ━E   ━E(options/*)  ━E   ━E Scripts     ━E     ━E
━E └──────┬───────━E   └──────┬───────━E   ━E(content/*)  ━E     ━E
━E        ━E                  ━E           └──────┬───────━E     ━E
━E        ━E                  ━E                  ━E              ━E
━E        └───────────┬───────┴───────────────────━E              ━E
━E                    ━EChrome Messages                           ━E
━E                    ▼                                           ━E
━E        ┌───────────────────────━E                              ━E
━E        ━E  Service Worker      ━E                              ━E
━E        ━E(background/service-  ━E                              ━E
━E        ━E   worker.js)         ━E                              ━E
━E        └───────────┬───────────━E                              ━E
━E                    ━E                                          ━E
━E                    ▼                                           ━E
━E        ┌───────────────────────━E                              ━E
━E        ━E  Chrome Storage      ━E                              ━E
━E        ━E  (storage/settings-  ━E                              ━E
━E        ━E   manager.js)        ━E                              ━E
━E        └───────────────────────━E                              ━E
━E                                                                 ━E
└─────────────────────────────────────────────────────────────────━E
```

### コンポEネント詳細

#### 1. Content ScriptsEコンチEチEクリプトEE

YouTube上で実行され、動画の回転処琁E拁Eします、E

| ファイル | 責勁E|
|---------|------|
| `index.js` | メインエントリーポイント。E期化とキーボEドイベントE琁E|
| `ai-detector.js` | Gemini API経由のAI判定による自動回転E実験機EEE|
| `face-detector.js` | 顔検Eによる自動回転判定（実験機EEE|
| `player-detector.js` | YouTubeプレイヤー要素の検Eと動画ID抽出 |
| `rotation-control.js` | 回転ロジチEの実裁EESS transformの適用 |
| `overlay-ui.js` | 回転ボタンUIの生Eと挿入 |

**処琁Eロー:**
```
ペEジ読み込み
    ━E
    ▼
PlayerDetector.init()
    ━Eプレイヤー要素を検E
    ▼
RotationControl.init()
    ━E回転制御をE期化
    ▼
OverlayUI.init()
    ━Eボタンを挿入
    ▼
FaceDetectorE有効時！E
    ━E自動回転検Eを試衁E
    ▼
イベントリスナE登録
    ━EキーボEドEクリチE
    ▼
動画刁E替え監視開姁E
```

#### 2. Background Service Worker

メチEージルーチEングとストレージ操作を拁Eします、E

**メチEージタイチE**

| メチEージ | 方吁E| 説昁E|
|-----------|------|------|
| `GET_SETTINGS` | Content ↁEBG | 設定を取征E|
| `UPDATE_SETTINGS` | Popup/Options ↁEBG | 設定を更新 |
| `SAVE_ROTATION` | Content ↁEBG | 動画の回転状態を保孁E|
| `GET_ROTATION` | Content ↁEBG | 動画の回転状態を取征E|
| `CLEAR_ALL_ROTATIONS` | Options ↁEBG | 保存済み回転をクリア |

#### 3. Popup

拡張機EアイコンクリチE時に表示されるクイチE操作UI、E

**機E:**
- 現在の回転角度表示
- ワンクリチE回転ボタンEE°/90°/180°/270°EE
- 現在のショートカチEキー表示
- 設定Eージへのリンク

#### 4. Options

設定画面。ユーザーが動作をカスタマイズできます、E

**設定頁E:**
- ボタン表示位置
- キーボEドショートカチE
- 自動回転検EE実験機EEE
- 検E方法（顔検E / AI判定！E
- 動画刁E替え時の動佁E
- 回転記Eの有無
- チEォルト回転角度

---

## チEEタ構造

### 設定！EettingsEE

```javascript
{
  hotkeyPreset: 'default' | 'alt' | 'ctrl',
  rememberRotation: boolean,
  resetOnVideoChange: boolean,
  buttonPosition: 'overlay' | 'controlbar',
  defaultRotation: 0 | 90 | 180 | 270,
  autoDetectRotation: boolean,  // 自動回転検EE実験機E、デフォルチEFFEE
  detectionMethod: 'face' | 'ai'  // 検E方法！Eace: 顔検E, ai: AI判定！E
}
```

### 動画回転状態！EideoRotationsEE

```javascript
{
  [videoId: string]: {
    rotation: 0 | 90 | 180 | 270,
    savedAt: number  // Unix timestamp
  }
}
```

---

## 回転実裁EE詳細

### CSS Transform アプローチE

動画要素に直接CSSクラスを適用して回転を実現します、E

```css
/* 90度回転 */
.rotate-screen-90 {
  transform: rotate(90deg) scale(var(--rotate-screen-scale)) !important;
}

/* 180度回転 */
.rotate-screen-180 {
  transform: rotate(180deg) !important;
}

/* 270度回転 */
.rotate-screen-270 {
  transform: rotate(270deg) scale(var(--rotate-screen-scale)) !important;
}
```

### スケール計箁E

90度/270度回転時、動画のアスペクト比が変わるため、コンチEに収まるよぁEケールを調整します、E

```javascript
// スケール計算ロジチE
function calculateScale(containerWidth, containerHeight) {
  const aspectRatio = containerWidth / containerHeight;
  // 90度/270度回転時E幁E高さがEれ替わる
  return Math.min(1, 1 / aspectRatio);
}
```

### YouTubeスタイル上書き対筁E

YouTubeはプレイヤー更新時にインラインスタイルを上書きするため、以下E対策を実施:

1. **CSSクラス + !important**: インラインスタイルより優先度を高くする
2. **MutationObserver**: スタイル変更を検知して再適用
3. **フルスクリーン対忁E*: フルスクリーン刁E替え時に回転をE適用

---

## YouTube プレイヤー検E

### 対象セレクター

```javascript
const SELECTORS = {
  player: '#movie_player',
  video: 'video.html5-main-video',
  controlBar: '.ytp-chrome-bottom',
  rightControls: '.ytp-right-controls'
};
```

### 動画ID抽出

褁EのURL形式に対忁E

| 形弁E| パターン | 侁E|
|-----|---------|-----|
| 標溁E| `/watch?v=` | `youtube.com/watch?v=dQw4w9WgXcQ` |
| ショーチE| `youtu.be/` | `youtu.be/dQw4w9WgXcQ` |
| 埋め込み | `/embed/` | `youtube.com/embed/dQw4w9WgXcQ` |

```javascript
function extractVideoId(url) {
  const patterns = [
    /[?&]v=([^&]+)/,           // 標準形弁E
    /youtu\.be\/([^?&]+)/,     // ショート形弁E
    /\/embed\/([^?&]+)/        // 埋め込み形弁E
  ];
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match) return match[1];
  }
  return null;
}
```

---

## イベントE琁E

### キーボEドショートカチE

```javascript
const HOTKEY_PRESETS = {
  default: { key: 'r', altKey: false, ctrlKey: false, shiftKey: false },
  alt:     { key: 'r', altKey: true,  ctrlKey: false, shiftKey: false },
  ctrl:    { key: 'r', altKey: false, ctrlKey: true,  shiftKey: true }
};
```

**除外条件:**
- 入力欁EEnput, textareaEにフォーカス中
- contentEditable要素にフォーカス中

### 動画刁E替え検E

YouTubeはSPAEEingle Page ApplicationEEため、Eージ遷移なしで動画がEり替わります、E

検E方況E
1. `yt-navigate-finish` イベンチE
2. URL変更監視！Epopstate`イベント！E
3. MutationObserverによるプレイヤー更新検知

---

## ストレージ設訁E

### Chrome Storage API

`chrome.storage.local`を使用E同期不要EためE、E

```javascript
// 設定E保孁E
await chrome.storage.local.set({
  settings: { ...newSettings }
});

// 動画回転の保孁E
await chrome.storage.local.set({
  videoRotations: {
    ...existing,
    [videoId]: { rotation, savedAt: Date.now() }
  }
});
```

### 容量制陁E

- `chrome.storage.local`: 最大5MB
- 動画ごとに紁E00バイチEↁE紁E0,000動画刁E存可能

---

## ビルドEロセス

### ファイル構E

```
src/           ↁE開発用ソースE直接読み込み可能EE
dist/          ↁEビルドE力（本番用EE
*.zip          ↁE配币EアーカイチE
```

### ビルドコマンチE

```bash
# Node.js
npm run build      # dist/ に出劁E
npm run package    # ZIP も作E

# PowerShell
.\scripts\build.ps1       # dist/ に出劁E
.\scripts\build.ps1 -Zip  # ZIP も作E
```

### ビルドE琁EE容

1. `dist/`フォルダをクリーン
2. 以下をコピE:
   - `manifest.json`
   - `assets/`
   - `background/`
   - `content/`
   - `popup/`
   - `options/`
   - `storage/`
   - `styles/`
   - `utils/`
3. EオプションEZIPアーカイブ作E

---

## 拡張ポインチE

### 新しい回転角度の追加

1. `constants.js`の`ROTATION_ANGLES`配Eに角度を追加
2. `overlay.css`に対応するCSSクラスを追加
3. `rotation-control.js`のロジチEを更新

### 新しいショートカチEプリセチE

1. `constants.js`の`HOTKEY_PRESETS`にプリセチEを追加
2. `options.html`に選択肢を追加

### 他E動画サイト対忁E

1. `manifest.json`の`host_permissions`にドメインを追加
2. `youtube-selectors.js`を汎用化またE新規セレクターファイル作E
3. `player-detector.js`を拡張

---

## 自動回転検EE実験機EEE

### 概要E

動画の向きをE動判定して回転する機Eです。デフォルトでは無効になってぁEす、E

### 検E方況E

設定画面で以下E2つの検E方法を選択できます！E

#### 1. 顔検EEローカル処琁EE

ブラウザ冁E完結する検E方法です、E

- **FaceDetector API**E優先！E
  - Chrome実験機Eとして提侁E
  - `chrome://flags/#enable-experimental-web-platform-features` で有効化が忁EE
  - 高精度だがブラウザサポEトが限定的

- **肌色刁E**EフォールバックEE
  - FaceDetector APIが利用できなぁE合に使用
  - 動画フレームめE刁Eして肌色刁EE刁E
  - 肌色が多い領域を頭部と推宁E

#### 2. AI判定！Eemini APIEE

Cloudflare Worker経由でGemini APIに画像を送信し、AIが向きを判定します、E

- **高精度**: LLMによる画像認識で正確な向き判宁E
- **外部通信**: Cloudflare Worker ↁEGemini APIへの通信が忁EE
- **タイムアウチE*: 10秒でタイムアウト、失敗時は顔検EにフォールバックしなぁE
- **API設宁E*: Cloudflare Worker側でGemini APIキーの設定が忁EE

### 処琁Eロー

```
動画読み込み
    ━E
    ▼
ライブE信チェチE ─── YES ──ↁE自動回転スキチEE
    ━E
    NO
    ▼
保存済み回転チェチE ─── あり ──ↁE保存済み回転を適用
    ━E
    なぁE
    ▼
検E方法E確誁E
    ━E
    ├── AI判宁E────────────────────────ↁECloudflare Worker経由でGemini API
    ━E                                     ━E
    ━E                                     ▼
    ━E                              10秒タイムアウチE
    ━E                                     ━E
    ━E                              成功 / 失敁E
    ━E                               ━E     ━E
    ━E                               ▼      ▼
    ━E                           回転適用   終亁Eフォールバックなし！E
    ━E
    └── 顔検E ────────────────────────ↁEFaceDetector API / 肌色刁E
                                           ━E
                                           ▼
                                    検E成功EE
                                       ━E
                                   YES / NO
                                    ━E    ━E
                                    ▼     ▼
                                 回転適用  手動回転征E
```

### Cloudflare Worker API仕槁E

AI判定で使用するCloudflare WorkerのエンドEイント！E

**リクエスチE**
```json
POST /detect-orientation
Content-Type: application/json

{
  "image": "data:image/jpeg;base64,...",
  "hint": "detect_video_orientation"
}
```

**レスポンス:**
```json
{
  "success": true,
  "rotation": 90,
  "confidence": 0.95,
  "reason": "人物が右向きに横たわってぁEため90度回転が忁EE
}
```

### 制限事頁E

- ライブE信では自動回転が無効
- 検E精度は限定的E誤検Eの可能性ありEE
- 動画の最初E数フレームで判定するため、E頭が暗ぁE画では検E困難
- AI判定Eタイムアウト時に顔検EへフォールバックしなぁE時間短縮のためEE

---

## 既知の制限事頁E

1. **YouTube限宁E*: 現在はYouTubeのみ対忁E
2. **Manifest V3**: Chrome専用EEirefox等E未対応！E
3. **ライブE信**: 自動回転は無効E手動回転は可能EE
4. **埋め込みプレイヤー**: 外部サイトE埋め込みは未対忁E
5. **顔検E精度**: 実験機Eのため検E精度は限定的

---

## セキュリチE老EE事頁E

- **最小権陁E*: 忁EなパEミッションのみ要汁E
- **XSS対筁E*: DOM操作時にサニタイズ
- **CSP対忁E*: インラインスクリプト不使用
- **チEEタ検証**: Storage読み書き時に型チェチE
