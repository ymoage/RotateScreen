# RotateScreen 設計ドキュメント

| 項目 | 値 |
|------|-----|
| バージョン | v1.3.3 |
| 更新日 | 2025-12-28 |

## 概要

RotateScreenは、YouTube動画を回転表示するChrome拡張機能です。横向きで撮影された動画を正しい向きで視聴するために開発されました。

### 主要機能

- **手動回転**: Rキーまたはボタンで動画を90度ずつ回転
- **フリー回転**: 長押しで任意の角度にゆっくり回転（斜め撮影動画対応）
- **左右反転（ミラー）**: Hキーで動画を左右反転（iPhoneインカメラ動画対応）
- **AI判定**: 右クリックでGemini APIによる自動向き判定
- **自動回転検出（実験機能）**: 顔検出による動画の向き自動判定
- **回転記憶**: 動画ごとの回転設定を保存
- **ライブ配信対応**: ライブ配信では自動回転を無効化

## アーキテクチャ

### 全体構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                       Chrome Browser                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ ┌──────────────┐   ┌──────────────┐   ┌──────────────┐         │
│ │   Popup      │   │  Options     │   │  Content     │         │
│ │ (popup/*)    │   │ (options/*)  │   │  Scripts     │         │
│ └──────┬───────┘   └──────┬───────┘   │ (content/*)  │         │
│        │                  │           └──────┬───────┘         │
│        │                  │                  │                 │
│        └───────────┬──────┴──────────────────┘                 │
│                    │ Chrome Messages                           │
│                    ▼                                           │
│        ┌───────────────────────┐                               │
│        │  Service Worker       │                               │
│        │ (background/service-  │                               │
│        │   worker.js)          │                               │
│        └───────────┬───────────┘                               │
│                    │                                           │
│                    ▼                                           │
│        ┌───────────────────────┐                               │
│        │  Chrome Storage       │                               │
│        │  (storage/settings-   │                               │
│        │   manager.js)         │                               │
│        └───────────────────────┘                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### コンポーネント詳細

#### 1. Content Scripts（コンテンツスクリプト）

YouTube上で実行され、動画の回転処理を担当します。

| ファイル | 責務 |
|---------|------|
| `index.js` | メインエントリーポイント。初期化とイベント処理 |
| `ai-detector.js` | Gemini API経由のAI判定による向き検出 |
| `face-detector.js` | 顔検出による自動回転判定（実験機能） |

**処理フロー:**
```
ページ読み込み
    │
    ▼
initialize()
    │ プレイヤー要素を検出
    ▼
setupRotation()
    │ UIを注入、保存済み回転を復元
    ▼
イベントリスナー登録
    │ キーボード・マウスイベント
    ▼
動画切り替え監視開始
```

#### 2. Background Service Worker

メッセージルーティングとストレージ操作を担当します。

**メッセージタイプ:**

| メッセージ | 方向 | 説明 |
|-----------|------|------|
| `GET_SETTINGS` | Content → BG | 設定を取得 |
| `UPDATE_SETTINGS` | Popup/Options → BG | 設定を更新 |
| `SAVE_ROTATION` | Content → BG | 動画の回転状態を保存 |
| `GET_ROTATION` | Content → BG | 動画の回転状態を取得 |
| `CLEAR_ALL_ROTATIONS` | Options → BG | 保存済み回転をクリア |

#### 3. Popup

拡張機能アイコンクリック時に表示されるクイック操作UI。

**機能:**
- 現在の回転角度表示
- ワンクリック回転ボタン（0°/90°/180°/270°）
- 現在のショートカットキー表示
- 設定ページへのリンク

#### 4. Options

設定画面。ユーザーが動作をカスタマイズできます。

**設定項目:**
- ボタン表示位置
- キーボードショートカット
- 自動回転検出（実験機能）
- AI判定設定（Gemini APIキー / Cloudflare Worker）
- 動画切り替え時の動作
- 回転記憶の有無
- デフォルト回転角度

---

## 回転機能

### 操作方法

| 操作 | 動作 |
|------|------|
| クリック | 90度刻みで回転 |
| 長押し | フリー回転（任意角度にゆっくり回転） |
| 右クリック | AI判定（Gemini APIで向きを自動判定） |
| ダブルクリック | 回転をリセット |
| Rキー | 90度刻みで回転 |
| Hキー | 左右反転（ミラー）を切り替え |

### 回転の種類

#### 1. 通常回転（90度刻み）
クリックまたはRキーで0°→90°→180°→270°→0°と循環します。

#### 2. フリー回転（任意角度）
長押しで動画がゆっくり回転し、離すとその角度で停止します。
斜めに撮影された動画を適切な角度で視聴するための機能です。

**設定:**
- 回転速度: 3度/50ms（約60度/秒）
- 回転角度に応じてスケーリングを自動調整

#### 3. 左右反転（ミラー）
Hキーで動画を左右反転（ミラー）します。
iPhoneのインカメラで撮影した動画がミラー表示になっている場合に便利です。

**特徴:**
- 回転と組み合わせ可能（回転 + ミラー）
- ショートカットは設定で変更可能（H / Alt+H / Ctrl+Shift+H / 無効）
- ダブルクリックでリセット時にミラーも解除

### CSS Transform アプローチ

動画要素に直接CSSクラスを適用して回転を実現します。

```css
/* 90度回転 */
.rotate-screen-90 {
  transform: rotate(90deg) scale(var(--rotate-screen-scale)) !important;
}

/* フリー回転（任意角度） */
.rotate-screen-free {
  transform: rotate(var(--rotate-screen-free-angle))
             scale(var(--rotate-screen-free-scale)) !important;
}
```

### スケール計算

90度/270度回転時、動画のアスペクト比が変わるため、コンテナに収まるようスケールを調整します。

フリー回転では、任意の角度に応じて動的にスケールを計算します。

```javascript
// フリー回転のスケール計算
const radians = (angle * Math.PI) / 180;
const sin = Math.abs(Math.sin(radians));
const cos = Math.abs(Math.cos(radians));
const newWidth = videoWidth * cos + videoHeight * sin;
const newHeight = videoWidth * sin + videoHeight * cos;
const scale = Math.min(videoWidth / newWidth, videoHeight / newHeight);
```

---

## データ構造

### 設定（settings）

```javascript
{
  hotkeyPreset: 'default' | 'alt' | 'ctrl',
  mirrorHotkeyPreset: 'default' | 'alt' | 'ctrl' | 'disabled',
  rememberRotation: boolean,
  resetOnVideoChange: boolean,
  buttonPosition: 'overlay' | 'controlbar',
  defaultRotation: 0 | 90 | 180 | 270,
  autoDetectRotation: boolean,
  detectionMethod: 'none' | 'face' | 'ai',
  aiMode: 'direct' | 'worker',
  aiGeminiApiKey: string,
  aiGeminiModel: string,
  aiApiEndpoint: string,
  aiAccessToken: string
}
```

### 動画回転状態（videoRotations）

```javascript
{
  [videoId: string]: {
    rotation: 0 | 90 | 180 | 270,  // 通常回転
    // または
    freeRotation: number,          // フリー回転（0-360）
    savedAt: number                // Unix timestamp
  }
}
```

---

## AI判定機能

### 概要

右クリックでGemini APIを使用して動画の向きを自動判定します。

### 接続方式

#### 1. Gemini API直接（簡単）
ブラウザから直接Gemini APIを呼び出します。
- Google AI StudioでAPIキーを取得
- 設定画面でAPIキーを入力

#### 2. Cloudflare Worker経由（上級者向け）
Cloudflare Worker経由でAPIを呼び出します。
- APIキーをサーバー側で管理できる
- アクセストークンによる認証が可能

### API仕様

**リクエスト:**
```json
POST /detect-orientation
Content-Type: application/json

{
  "image": "data:image/jpeg;base64,...",
  "model": "gemini-2.0-flash"
}
```

**レスポンス:**
```json
{
  "success": true,
  "rotation": 90,
  "confidence": 0.95,
  "reason": "人物が右向きに横たわっているため90度回転が必要"
}
```

---

## ビルドプロセス

### ファイル構成

```
src/           → 開発用ソース（直接読み込み可能）
dist/          → ビルド出力（本番用）
*.zip          → 配布用アーカイブ
```

### ビルドコマンド

```bash
# Node.js
npm run build      # dist/ に出力
npm run package    # ZIP も作成

# PowerShell
.\scripts\build.ps1       # dist/ に出力
.\scripts\build.ps1 -Zip  # ZIP も作成
```

---

## 既知の制限事項

1. **YouTube限定**: 現在はYouTubeのみ対応
2. **Manifest V3**: Chrome専用（Firefox等は未対応）
3. **ライブ配信**: 自動回転は無効（手動回転は可能）
4. **埋め込みプレイヤー**: 外部サイトの埋め込みは未対応
5. **顔検出精度**: 実験機能のため検出精度は限定的

---

## セキュリティ考慮事項

- **最小権限**: 必要なパーミッションのみ要求
- **XSS対策**: DOM操作時にサニタイズ
- **CSP対応**: インラインスクリプト不使用
- **データ検証**: Storage読み書き時に型チェック
