# RotateScreen 関数リファレンス

| 項目 | 値 |
|------|-----|
| バージョン | v1.3.2 |
| 更新日 | 2025-12-19 |

各ファイルに定義されている関数の詳細なリファレンスです。

---

## 目次

1. [content/index.js](#contentindexjs)
2. [content/ai-detector.js](#contentai-detectorjs)
3. [content/face-detector.js](#contentface-detectorjs)

---

## content/index.js

メインのコンテンツスクリプト。YouTubeページに回転機能を注入する単一ファイル版。

### ユーティリティ関数

#### `isValidRotation(rotation)`
回転角度が有効かチェックする。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `rotation` | `number` | チェックする角度 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 有効な角度（0, 90, 180, 270）なら`true` |

---

#### `getNextRotation(current)`
次の回転角度を計算する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `current` | `number` | 現在の角度 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `number` | 次の角度（90度加算、360で0に戻る） |

---

### 回転制御

#### `setRotation(rotation)`
通常回転（90度刻み）を設定する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `rotation` | `number` | 設定する角度（0, 90, 180, 270） |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 成功なら`true` |

---

#### `setFreeRotation(angle)`
フリー回転（任意角度）を設定する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `angle` | `number` | 設定する角度（0-360、範囲外も可） |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 成功なら`true` |

**動作:**
- 角度を0-360の範囲に正規化
- 回転角度に応じたスケールを計算
- CSS変数`--rotate-screen-free-angle`と`--rotate-screen-free-scale`を設定
- `rotate-screen-free`クラスを適用

---

#### `clearFreeRotation()`
フリー回転をクリアする。

**動作:**
- `rotate-screen-free`クラスを削除
- CSS変数をクリア
- `isFreeRotationMode`を`false`に設定

---

#### `rotateNext()`
次の回転角度に進める。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `number` | 新しい角度 |

---

#### `resetRotation()`
回転を0度にリセットする。フリー回転もクリアされる。

---

### UI関連

#### `createRotateButton(isControlbar)`
回転ボタンを作成する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `isControlbar` | `boolean` | コントロールバー用のスタイルを使用するか |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `HTMLButtonElement` | 作成されたボタン要素 |

**イベント:**
- `click`: 90度刻みで回転
- `mousedown`（長押し）: フリー回転を開始
- `mouseup`: フリー回転を停止
- `contextmenu`（右クリック）: AI判定を実行
- `dblclick`: 回転をリセット

---

#### `showFreeRotationIndicator(angle)`
フリー回転中のインジケータを表示する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `angle` | `number` | 現在の角度 |

---

#### `updateFreeRotationIndicator(angle)`
フリー回転インジケータの角度を更新する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `angle` | `number` | 現在の角度 |

---

#### `hideFreeRotationIndicator()`
フリー回転インジケータを非表示にする。

---

### ストレージ

#### `loadVideoRotation(videoId)`
保存された回転設定を読み込む。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `videoId` | `string` | 動画ID |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<object\|null>` | `{type: 'normal'|'free', angle: number}` または `null` |

---

#### `saveVideoRotation(videoId, rotation)`
通常回転設定を保存する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `videoId` | `string` | 動画ID |
| `rotation` | `number` | 回転角度 |

---

#### `saveFreeVideoRotation(videoId, freeRotation)`
フリー回転設定を保存する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `videoId` | `string` | 動画ID |
| `freeRotation` | `number` | 回転角度 |

---

### AI判定

#### `isAIDetectionAvailable()`
AI判定が利用可能かチェックする。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 利用可能なら`true` |

**条件:**
- `detectionMethod`が`none`でない
- `RotateScreenAIDetector`モジュールがロードされている
- APIが設定されている

---

#### `handleManualAIDetection()`
手動でAI判定を実行する。右クリックで呼び出される。

**動作:**
1. 動画フレームをキャプチャ
2. Gemini APIに送信
3. 判定結果に基づいて回転を適用
4. 結果を保存

---

### 初期化

#### `initialize()`
拡張機能を初期化する。ページ読み込み時に自動実行。

**処理:**
1. YouTubeページか確認
2. 設定を読み込み
3. プレイヤーの準備を待機
4. 回転機能をセットアップ
5. イベントリスナーを登録
6. 動画切り替え監視を開始

---

## content/ai-detector.js

Gemini API経由で動画の向きを判定するモジュール。

### 主要関数

#### `detectVideoOrientation(video, options)`
動画の向きをAI判定する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `video` | `HTMLVideoElement` | 動画要素 |
| `options.timeout` | `number` | タイムアウト（ミリ秒、デフォルト10000） |
| `options.maxSize` | `number` | 画像の最大サイズ（デフォルト512） |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<object>` | 判定結果 |

**戻り値の形式:**
```javascript
{
  detected: boolean,      // 判定成功したか
  rotation: number|null,  // 推奨回転角度（0, 90, 180, 270）
  confidence: number,     // 信頼度（0-1）
  reason: string,         // 判定理由
  method: string          // 使用した方法（'ai-direct' | 'ai'）
}
```

---

#### `isConfigured()`
APIが設定されているかチェックする。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 設定されていれば`true` |

---

#### `getConfig()`
現在の設定を取得する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `object` | 設定オブジェクト |

---

## content/face-detector.js

顔検出による自動回転判定モジュール（実験機能）。

### 主要関数

#### `detectVideoOrientation(video)`
顔検出で動画の向きを判定する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `video` | `HTMLVideoElement` | 動画要素 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<object>` | 判定結果 |

**戻り値の形式:**
```javascript
{
  detected: boolean,      // 判定成功したか
  rotation: number|null,  // 推奨回転角度
  confidence: number,     // 信頼度
  method: string          // 使用した方法（'facedetector' | 'skincolor'）
}
```

---

#### `isSupported()`
顔検出がサポートされているかチェックする。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | サポートされていれば`true` |

---

## グローバルオブジェクト

### `window.RotateScreenAIDetector`

AI判定モジュールが公開するインターフェース。

```javascript
{
  detectVideoOrientation: Function,
  captureFrame: Function,
  isConfigured: Function,
  getConfig: Function,
  DEFAULT_TIMEOUT: number
}
```

### `window.RotateScreenFaceDetector`

顔検出モジュールが公開するインターフェース。

```javascript
{
  detectVideoOrientation: Function,
  isSupported: Function
}
```
