# RotateScreen 関数リファレンス

| 項目 | 値 |
|------|-----|
| バージョン | v1.2.0 |
| リビジョン | 16c8e12 |
| 更新日 | 2025-12-10 |

各ファイルに定義されている関数の詳細なリファレンスです。

---

## 目次

1. [content/index.js](#contentindexjs)
2. [content/face-detector.js](#contentface-detectorjs)
3. [content/player-detector.js](#contentplayer-detectorjs)
4. [content/rotation-control.js](#contentrotation-controljs)
5. [content/overlay-ui.js](#contentoverlay-uijs)
6. [background/service-worker.js](#backgroundservice-workerjs)
7. [storage/settings-manager.js](#storagesettings-managerjs)
8. [utils/constants.js](#utilsconstantsjs)
9. [utils/youtube-selectors.js](#utilsyoutube-selectorsjs)
10. [popup/popup.js](#popuppopupjs)
11. [options/options.js](#optionsoptionsjs)

---

## content/index.js

メインのコンテンツスクリプト。YouTubeページに回転機能を注入する単一ファイル版。

### ユーティリティ関数

#### `isValidRotation(rotation)`
回転角度が有効かチェックする。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `rotation` | `number` | チェックする角度 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 有効な角度（0, 90, 180, 270）なら `true` |

---

#### `getNextRotation(current)`
次の回転角度を計算する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `current` | `number` | 現在の回転角度 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `number` | 次の回転角度（90度加算、360で循環） |

---

#### `extractVideoId(url)`
URLからYouTube動画IDを抽出する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `url` | `string` | YouTubeのURL |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `string\|null` | 動画ID、抽出できない場合は `null` |

対応形式:
- 標準: `youtube.com/watch?v=xxxxx`
- 短縮: `youtu.be/xxxxx`
- 埋め込み: `youtube.com/embed/xxxxx`

---

#### `isYouTube()`
現在のページがYouTubeかチェックする。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | YouTubeなら `true` |

---

#### `isLiveStream()`
現在の動画がライブ配信かチェックする。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | ライブ配信なら `true` |

検出方法:
- URLに `/live/` が含まれる
- `.ytp-live-badge` 要素が表示されている
- プレイヤーに `ytp-live` クラスがある
- ライブチャット要素が存在する

---

### プレイヤー検出関数

#### `detectPlayer()`
YouTubeの動画プレイヤー要素を取得する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `HTMLElement\|null` | `#movie_player` 要素 |

---

#### `detectVideoContainer()`
動画コンテナ要素を取得する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `HTMLElement\|null` | `.html5-video-container` 要素 |

---

#### `detectVideo()`
video要素を取得する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `HTMLVideoElement\|null` | `video.html5-main-video` 要素 |

---

#### `getCurrentVideoId()`
現在のページの動画IDを取得する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `string\|null` | 動画ID |

---

#### `isPlayerReady()`
プレイヤーが準備完了かチェックする。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | プレイヤーとビデオ要素が存在すれば `true` |

---

#### `waitForPlayer(timeout, interval)`
プレイヤーの準備を待つ。

| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|-----------|------|
| `timeout` | `number` | `10000` | タイムアウト（ミリ秒） |
| `interval` | `number` | `500` | チェック間隔（ミリ秒） |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<boolean>` | プレイヤーが見つかったら `true` |

---

### 回転制御関数

#### `removeRotationClasses(video)`
動画要素から回転関連のCSSクラスを削除する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `video` | `HTMLVideoElement` | 動画要素 |

---

#### `setRotation(rotation)`
動画の回転角度を設定する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `rotation` | `number` | 回転角度（0, 90, 180, 270） |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 成功なら `true` |

処理内容:
1. 既存の回転クラスを削除
2. 新しい回転クラスを追加
3. 90度/270度の場合はスケール計算
4. ボタン状態を更新

---

#### `rotateNext()`
次の角度に回転する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `number` | 新しい回転角度 |

---

#### `resetRotation()`
回転を0度にリセットする。

---

### UI関数

#### `createRotateButton(isControlbar)`
回転ボタンを作成する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `isControlbar` | `boolean` | コントロールバー用ボタンなら `true` |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `HTMLButtonElement` | ボタン要素 |

---

#### `updateButtonState(rotation)`
ボタンの表示状態を更新する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `rotation` | `number` | 現在の回転角度 |

---

#### `removeExistingButton()`
既存の回転ボタンを削除する。

---

#### `injectOverlayUI()`
オーバーレイ位置にボタンを挿入する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 成功なら `true` |

---

#### `injectControlbarUI()`
コントロールバーにボタンを挿入する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 成功なら `true`（失敗時はオーバーレイにフォールバック） |

---

#### `injectUI()`
設定に応じた位置にボタンを挿入する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 成功なら `true` |

---

### キーボードショートカット関数

#### `isInputFocused(target)`
入力要素にフォーカスがあるかチェックする。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `target` | `HTMLElement` | イベントターゲット |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | input/textarea/contentEditableなら `true` |

---

#### `matchesHotkey(event, preset)`
キーイベントがホットキープリセットと一致するかチェックする。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `event` | `KeyboardEvent` | キーボードイベント |
| `preset` | `object` | ホットキープリセット設定 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 一致すれば `true` |

---

#### `handleKeyDown(event)`
keydownイベントハンドラ。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `event` | `KeyboardEvent` | キーボードイベント |

---

### ストレージ関数

#### `loadSettings()`
Chrome Storageから設定を読み込む。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<void>` | - |

読み込む設定:
- `hotkeyPreset`: キーボードショートカット
- `rememberRotation`: 回転記憶の有無
- `resetOnVideoChange`: 動画切り替え時リセット
- `buttonPosition`: ボタン表示位置

---

#### `loadVideoRotation(videoId)`
動画の保存済み回転角度を読み込む。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `videoId` | `string` | YouTube動画ID |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<number\|null>` | 保存済み回転角度、なければ `null` |

---

#### `saveVideoRotation(videoId, rotation)`
動画の回転角度を保存する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `videoId` | `string` | YouTube動画ID |
| `rotation` | `number` | 回転角度 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<void>` | - |

---

### 自動回転関数

#### `tryAutoRotation(video)`
顔検出による自動回転を試行する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `video` | `HTMLVideoElement` | 動画要素 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<boolean>` | 自動回転が適用された場合 `true` |

処理内容:
1. 自動回転が有効かチェック
2. ライブ配信ならスキップ
3. FaceDetectorモジュールで検出
4. 検出成功なら回転を適用
5. 通知を表示

---

#### `showAutoRotationNotification(rotation, method)`
自動回転通知を表示する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `rotation` | `number` | 適用された回転角度 |
| `method` | `string` | 検出方法（`'faceapi'` or `'color'`） |

3秒後に自動的にフェードアウトする。

---

### メインロジック関数

#### `handleRotate()`
回転操作を実行する。

処理内容:
1. 次の角度に回転
2. 動画IDがあれば回転状態を保存

---

#### `setupRotation()`
回転機能をセットアップする。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<void>` | - |

処理内容:
1. UIを挿入
2. 保存済み回転があれば復元

---

#### `observeVideoChange()`
動画切り替えを監視する。

MutationObserverを使用してタイトル変更とDOM変更を監視し、動画切り替え時に回転をリセット/復元する。

---

#### `handleFullscreenChange()`
フルスクリーン切り替え時のハンドラ。

100ms遅延後に現在の回転を再適用する。

---

#### `initialize()`
拡張機能を初期化する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<void>` | - |

処理内容:
1. YouTubeページかチェック
2. 設定を読み込み
3. プレイヤー準備を待機
4. 回転機能をセットアップ
5. イベントリスナーを登録
6. 動画切り替え監視を開始

---

## content/face-detector.js

顔検出による動画の向き判定モジュール（実験機能）。

### グローバル変数

| 変数名 | 型 | 説明 |
|--------|-----|------|
| `isFaceDetectionSupported` | `boolean` | FaceDetector APIが利用可能か |

---

### 関数

#### `createFaceDetector()`
FaceDetector APIのインスタンスを作成する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `FaceDetector\|null` | 検出器インスタンス、サポートされていない場合は `null` |

---

#### `isSkinColor(r, g, b)`
ピクセルが肌色かどうかを判定する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `r` | `number` | 赤成分（0-255） |
| `g` | `number` | 緑成分（0-255） |
| `b` | `number` | 青成分（0-255） |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 肌色と判定されれば `true` |

判定基準:
- R > G > B の関係
- 色相が0-50度または340-360度（赤〜オレンジ〜黄色）
- 適切な明度と彩度

---

#### `detectByColorAnalysis(video)`
肌色分析による向き検出（フォールバック）。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `video` | `HTMLVideoElement` | 動画要素 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<object>` | `{ detected: boolean, rotation: number\|null, confidence: number }` |

処理内容:
1. 動画を100x100のキャンバスに描画
2. 4領域（上下左右）の肌色比率を計算
3. 肌色が多い領域を頭部と推定
4. 推定された向きから回転角度を決定

---

#### `detectByFaceAPI(detector, video)`
FaceDetector APIを使った顔検出。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `detector` | `FaceDetector` | 検出器インスタンス |
| `video` | `HTMLVideoElement` | 動画要素 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<object>` | `{ detected: boolean, rotation: number\|null, confidence: number }` |

---

#### `analyzeFromLandmarks(landmarks)`
顔のランドマークから向きを分析する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `landmarks` | `Array` | 顔のランドマーク配列 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `object` | `{ detected: boolean, rotation: number\|null, confidence: number }` |

目と口の位置関係から角度を計算し、回転を判定する。

---

#### `detectVideoOrientation(video)`
動画の向きを検出するメイン関数。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `video` | `HTMLVideoElement` | 動画要素 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<object>` | `{ detected: boolean, rotation: number\|null, method: string, confidence: number }` |

処理順序:
1. FaceDetector APIを試行
2. 失敗した場合は肌色分析にフォールバック

---

#### `isPortraitVideo(video)`
縦動画かどうかを判定する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `video` | `HTMLVideoElement` | 動画要素 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 縦動画なら `true` |

---

### グローバルオブジェクト

`window.RotateScreenFaceDetector` としてエクスポート:

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `detectVideoOrientation` | `function` | 向き検出メイン関数 |
| `isPortraitVideo` | `function` | 縦動画判定関数 |
| `isSupported` | `boolean` | FaceDetector APIサポート状況 |

---

## content/player-detector.js

YouTubeの動画プレイヤーを検出するモジュール。

#### `detectPlayer()`
動画プレイヤーを検出する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `HTMLElement\|null` | プレイヤー要素 |

---

#### `detectVideoContainer()`
動画コンテナを検出する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `HTMLElement\|null` | 動画コンテナ要素 |

---

#### `detectVideo()`
動画要素を検出する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `HTMLVideoElement\|null` | 動画要素 |

---

#### `getCurrentVideoId()`
現在の動画IDを取得する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `string\|null` | 動画ID |

---

#### `isPlayerReady()`
プレイヤーが存在するかチェックする。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 準備完了なら `true` |

---

#### `waitForPlayer(timeout, interval)`
プレイヤーの準備を待つ。

| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|-----------|------|
| `timeout` | `number` | `10000` | タイムアウト（ms） |
| `interval` | `number` | `500` | チェック間隔（ms） |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<boolean>` | 見つかったら `true` |

---

#### `observeVideoChange(callback)`
URL変更を監視して動画ID変更を検出する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `callback` | `function` | 動画ID変更時に呼ばれるコールバック |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `function` | 監視解除関数 |

---

## content/rotation-control.js

CSS transformを使用した動画回転ロジック。

#### `getCurrentRotation()`
現在の回転角度を取得する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `number` | 現在の回転角度 |

---

#### `setRotation(rotation)`
回転角度を設定する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `rotation` | `number` | 回転角度（0, 90, 180, 270） |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 成功なら `true` |

---

#### `rotateNext()`
次の角度に回転する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `number` | 新しい回転角度 |

---

#### `resetRotation()`
回転をリセット（0度に戻す）する。

---

#### `removeRotationClasses(element)` (内部関数)
回転クラスを削除する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `element` | `HTMLElement` | 対象要素 |

---

#### `calculateScale(video)` (内部関数)
90度/270度回転時のスケールを計算する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `video` | `HTMLVideoElement` | 動画要素 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `number` | スケール値（デフォルト: 0.5625 = 9/16） |

---

#### `handleFullscreenChange()`
フルスクリーン変更時の回転再適用。

100ms遅延後に現在の回転を再適用する。

---

#### `initRotation(initialRotation)`
回転状態を初期化する。

| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|-----------|------|
| `initialRotation` | `number` | `0` | 初期回転角度 |

---

## content/overlay-ui.js

動画プレイヤー上にオーバーレイボタンを注入するモジュール。

#### `createRotateButton()` (内部関数)
回転ボタンを作成する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `HTMLButtonElement` | ボタン要素 |

---

#### `handleRotateClick()` (内部関数)
回転ボタンクリックハンドラ。

---

#### `handleResetClick()` (内部関数)
リセットクリックハンドラ（ダブルクリック時）。

---

#### `updateButtonState(rotation)`
ボタンの状態を更新する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `rotation` | `number` | 回転角度 |

---

#### `injectOverlayUI()`
オーバーレイUIを注入する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 成功なら `true` |

---

#### `removeOverlayUI()`
オーバーレイUIを削除する。

---

#### `isOverlayUIInjected()`
オーバーレイUIが存在するかチェックする。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 存在すれば `true` |

---

#### `syncButtonState(rotation)`
回転角度でボタン状態を更新する（外部呼び出し用）。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `rotation` | `number` | 回転角度 |

---

## background/service-worker.js

バックグラウンドサービスワーカー。メッセージング処理と設定管理を担当。

#### `handleMessage(message)` (内部関数)
メッセージを処理する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `message` | `object` | メッセージオブジェクト（type, payload） |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<object>` | レスポンスオブジェクト |

対応メッセージタイプ:
- `GET_SETTINGS`: 設定を取得
- `UPDATE_SETTINGS`: 設定を更新
- `GET_ROTATION`: 動画の回転設定を取得
- `SAVE_ROTATION`: 動画の回転設定を保存
- `CLEAR_ALL_ROTATIONS`: すべての回転設定を削除

---

#### `handleGetSettings()` (内部関数)
設定を取得する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<object>` | `{ success: boolean, data?: object, error?: object }` |

---

#### `handleUpdateSettings(payload)` (内部関数)
設定を更新する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `payload` | `object` | 更新する設定 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<object>` | `{ success: boolean, error?: object }` |

---

#### `handleGetRotation(payload)` (内部関数)
動画の回転設定を取得する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `payload` | `object` | `{ videoId: string }` |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<object>` | `{ success: boolean, data?: object, error?: object }` |

---

#### `handleSaveRotation(payload)` (内部関数)
動画の回転設定を保存する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `payload` | `object` | `{ videoId: string, rotation: number }` |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<object>` | `{ success: boolean, error?: object }` |

---

#### `handleClearAllRotations()` (内部関数)
すべての回転設定を削除する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<object>` | `{ success: boolean, data?: { deletedCount: number }, error?: object }` |

---

## storage/settings-manager.js

Chrome Storage APIを使用した設定管理モジュール。

#### `getSettings()`
設定を取得する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<object>` | 設定オブジェクト（デフォルト値とマージ済み） |

---

#### `updateSettings(updates)`
設定を更新する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `updates` | `object` | 更新する設定 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<void>` | - |

---

#### `getVideoRotation(videoId)`
動画の回転設定を取得する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `videoId` | `string` | YouTube動画ID |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<object\|null>` | `{ rotation: number, savedAt: number }` または `null` |

---

#### `saveVideoRotation(videoId, rotation)`
動画の回転設定を保存する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `videoId` | `string` | YouTube動画ID |
| `rotation` | `number` | 回転角度（0, 90, 180, 270） |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<void>` | - |

| 例外 | 説明 |
|------|------|
| `Error` | videoIdまたはrotationが無効な場合 |

---

#### `deleteVideoRotation(videoId)`
動画の回転設定を削除する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `videoId` | `string` | YouTube動画ID |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<void>` | - |

---

#### `clearAllVideoRotations()`
すべての動画回転設定を削除する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<number>` | 削除した件数 |

---

#### `getAllStorage()`
ストレージの全データを取得する（デバッグ用）。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<object>` | 全ストレージデータ |

---

## utils/constants.js

回転角度とホットキープリセットの定義。

### 定数

| 定数名 | 型 | 値 | 説明 |
|--------|-----|-----|------|
| `ROTATION_ANGLES` | `number[]` | `[0, 90, 180, 270]` | 有効な回転角度 |
| `DEFAULT_ROTATION` | `number` | `0` | デフォルト回転角度 |
| `DEFAULT_HOTKEY_PRESET` | `string` | `'default'` | デフォルトのホットキープリセット |

### `HOTKEY_PRESETS`

| プリセットID | キー | 修飾キー | 説明 |
|-------------|------|---------|------|
| `default` | `r` | なし | Rキーのみ |
| `alt` | `r` | Alt | Alt + R |
| `ctrl` | `r` | Ctrl + Shift | Ctrl + Shift + R |

### `STORAGE_KEYS`

| キー | 値 | 説明 |
|-----|-----|------|
| `SETTINGS` | `'settings'` | 設定のストレージキー |
| `VIDEO_ROTATIONS` | `'videoRotations'` | 動画回転のストレージキー |

### `BUTTON_POSITIONS`

| キー | 値 | 説明 |
|-----|-----|------|
| `overlay` | `'overlay'` | オーバーレイ（動画左上） |
| `controlbar` | `'controlbar'` | コントロールバー |

### `DEFAULT_SETTINGS`

| プロパティ | デフォルト値 | 説明 |
|-----------|-------------|------|
| `hotkeyPreset` | `'default'` | キーボードショートカット |
| `rememberRotation` | `true` | 回転を記憶するか |
| `defaultRotation` | `0` | デフォルト回転角度 |
| `resetOnVideoChange` | `true` | 動画切り替え時にリセット |
| `buttonPosition` | `'overlay'` | ボタン表示位置 |
| `autoDetectRotation` | `false` | 顔検出による自動回転（実験機能） |

### `MESSAGE_TYPES`

| キー | 値 | 説明 |
|-----|-----|------|
| `GET_SETTINGS` | `'GET_SETTINGS'` | 設定取得 |
| `UPDATE_SETTINGS` | `'UPDATE_SETTINGS'` | 設定更新 |
| `SAVE_ROTATION` | `'SAVE_ROTATION'` | 回転保存 |
| `GET_ROTATION` | `'GET_ROTATION'` | 回転取得 |
| `CLEAR_ALL_ROTATIONS` | `'CLEAR_ALL_ROTATIONS'` | 全回転削除 |

### 関数

#### `getNextRotation(currentRotation)`
次の回転角度を計算する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `currentRotation` | `number` | 現在の回転角度 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `number` | 次の回転角度 |

---

#### `isValidRotation(rotation)`
回転角度が有効かチェックする。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `rotation` | `number` | チェックする角度 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | 有効なら `true` |

---

## utils/youtube-selectors.js

YouTubeのDOMセレクター定義。

### `YOUTUBE_SELECTORS`

| キー | セレクター | 説明 |
|-----|-----------|------|
| `player` | `#movie_player` | メイン動画プレイヤー |
| `videoContainer` | `.html5-video-container` | 動画コンテナ（回転適用対象） |
| `video` | `video.html5-main-video` | 動画要素 |
| `controls` | `.ytp-chrome-bottom` | プレイヤーコントロール |
| `fullscreenButton` | `.ytp-fullscreen-button` | フルスクリーンボタン |
| `playerWrapper` | `#player-container-outer` | プレイヤーのラッパー |

### `SUPPORTED_SITES.youtube`

YouTubeサイトの定義オブジェクト。

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `id` | `string` | `'youtube'` |
| `name` | `string` | `'YouTube'` |
| `hostPattern` | `string` | `'*://*.youtube.com/*'` |
| `hostRegex` | `RegExp` | `/^https?:\/\/(www\.)?youtube\.com/` |
| `selectors` | `object` | `YOUTUBE_SELECTORS` |

#### `SUPPORTED_SITES.youtube.extractVideoId(url)`
URLからYouTube動画IDを抽出する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `url` | `string` | ページURL |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `string\|null` | 動画ID または `null` |

### 関数

#### `getSupportedSite(url)`
現在のサイトが対応サイトかチェックする。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `url` | `string` | チェックするURL |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `object\|null` | 対応サイト定義 または `null` |

---

#### `isYouTube()`
現在のページがYouTubeかチェックする。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `boolean` | YouTubeなら `true` |

---

## popup/popup.js

ポップアップページのロジック。

#### `initialize()`
初期化する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<void>` | - |

処理内容:
1. 現在のタブを取得
2. サイト情報を表示
3. 設定を読み込む
4. イベントリスナーを設定

---

#### `updateSiteInfo(url)`
サイト情報を更新する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `url` | `string` | 現在のタブURL |

---

#### `showUnsupportedMessage()`
未対応サイトメッセージを表示する。

---

#### `loadSettings()`
設定を読み込む。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<void>` | - |

---

#### `updateHotkeyHint(presetId)`
ホットキーヒントを更新する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `presetId` | `string` | プリセットID |

---

#### `setupEventListeners()`
イベントリスナーを設定する。

---

#### `setRotation(rotation)`
回転を設定する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `rotation` | `number` | 回転角度 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<void>` | - |

Content Scriptに `SET_ROTATION` メッセージを送信する。

---

#### `updateRotationUI(rotation)`
回転UIを更新する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `rotation` | `number` | 回転角度 |

---

## options/options.js

設定ページのロジック。

#### `initialize()`
初期化する。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<void>` | - |

処理内容:
1. 現在の設定を読み込む
2. イベントリスナーを設定

---

#### `loadSettings()`
設定を読み込む。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<void>` | - |

---

#### `setupEventListeners()`
イベントリスナーを設定する。

監視する要素:
- ボタン表示位置選択
- ホットキープリセット選択
- 動画切り替え時リセットチェックボックス
- 回転記憶チェックボックス
- デフォルト回転選択
- 回転設定クリアボタン

---

#### `saveSettings(updates)`
設定を保存する。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `updates` | `object` | 更新する設定 |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<void>` | - |

---

#### `clearAllRotations()`
すべての回転設定をクリアする。

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| - | `Promise<void>` | - |

---

#### `showSaveNotification()`
保存通知を表示する。

2秒後に自動で非表示になる。
